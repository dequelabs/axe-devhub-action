name: Tests

on:
  # TODO: delete after testing
  push:
  pull_request:
    branches:
      - main

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - uses: ludeeus/action-shellcheck@00cae500b08a931fb5698e11e79bfbd38e612a38 # tag=v2.0.0
  workflow-lint:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v6
      - uses: reviewdog/action-actionlint@0d952c597ef8459f634d7145b0b044a9699e5e43 # tag=v1.71.0
  validate-action-yml:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v6
      - name: Validate action.yml
        run: |
          python3 -c "
          import yaml, sys
          try:
              with open('action.yml') as f:
                  action = yaml.safe_load(f)
              assert 'name' in action, 'Missing: name'
              assert 'description' in action, 'Missing: description'
              assert 'runs' in action, 'Missing: runs'
              assert 'steps' in action['runs'], 'Missing: runs.steps'
              print('action.yml is valid')
          except Exception as e:
              print(f'::error::{e}')
              sys.exit(1)
          "
  run-watcher-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      commit_sha: ${{ steps.get-sha.outputs.commit_sha }}
    steps:
      - name: Checkout watcher-examples repo
        uses: actions/checkout@v6
        with:
          repository: dequelabs/watcher-examples
      - name: Setup Node.js
        uses: actions/setup-node@v6
      - name: Install dependencies
        working-directory: js/playwright/basic
        run: npm install
      - name: Install Playwright specific dependencies
        working-directory: js/playwright/basic
        run: npx playwright install chromium --with-deps
      - name: Run Playwright tests with debug output
        working-directory: js/playwright/basic
        run: DEBUG="axe*" npm run test
        env:
          API_KEY: ${{ secrets.API_AXE_WATCHER_IN_DEV_FOR_TESTS_YML }}
          PROJECT_ID: ${{ secrets.PROJECT_ID_AXE_WATCHER_IN_DEV_FOR_TESTS_YML }}
          SERVER_URL: 'https://axe.dequelabs.com'
      - name: Get commit SHA
        id: get-sha
        run: echo "commit_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
  run-devhub-action:
    needs: run-watcher-tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6
      - name: Run axe DevHub action
        id: axe-devhub-action
        uses: ./
        continue-on-error: true
        with:
          github_token: ${{ secrets.PAT }}
          project_id: ${{ secrets.PROJECT_ID_AXE_WATCHER_IN_DEV_FOR_TESTS_YML }}
          api_key: ${{ secrets.API_AXE_WATCHER_IN_DEV_FOR_TESTS_YML }}
          commit_sha: ${{ needs.run-watcher-tests.outputs.commit_sha }}
          server_url: 'https://axe.dequelabs.com'
          retry_count: '3'
      - name: Verify expected failure
        run: |
          if [ "${{ steps.axe-devhub-action.outcome }}" = "failure" ] && [ "${{ steps.axe-devhub-action.outputs.issue_count }}" -gt 0 ]; then
            echo "Action failed with ${{ steps.axe-devhub-action.outputs.issue_count }} violations â€” expected behavior."
          else
            echo "::error::Unexpected outcome: ${{ steps.axe-devhub-action.outcome }}, issue_count: ${{ steps.axe-devhub-action.outputs.issue_count }}"
            exit 1
          fi
